<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Spinning WebGL Box</title>
<style>
body, html {
  margin: 0px;
  width: 100%;
  height: 100%;
  overflow: hidden;
}
#framerate {
  position: absolute;
  top: 10px;
  left: 10px;
  background-color: rgba(0,0,0,0.3);
  padding: 1em;
  color: white;
}
#example {
  width: 100%;
  height: 100%;
}
</style>
<script type="text/javascript" src="WebGL_Quad_files/webgl-utils.js"></script>
<script type="text/javascript" src="WebGL_Quad_files/webgl-debug.js"></script>
<script src="WebGL_Quad_files/J3DI.js"> </script>
<script src="WebGL_Quad_files/J3DIMath.js" type="text/javascript"> </script>
<script id="vshader" type="x-shader/x-vertex">
    uniform mat4 u_modelViewProjMatrix;
    uniform mat4 u_normalMatrix;

    attribute vec3 vNormal;
    attribute vec4 vTexCoord;
    attribute vec4 vPosition;

    varying vec2 v_texCoord;

    void main()
    {
        gl_Position = u_modelViewProjMatrix * vPosition;
        v_texCoord = vTexCoord.st;
        vec4 transNormal = u_normalMatrix * vec4(vNormal, 1);
    }
</script>

<script id="fshaderCDF" type="x-shader/x-fragment">
	
    precision mediump float;

    uniform sampler2D sampler2d0;
    uniform sampler2D sampler2d1;
    uniform sampler2D sampler2d2;

    varying vec2 v_texCoord;

    void main()
    {
        vec2 texCoord = vec2(v_texCoord.s, 1.0 - v_texCoord.t);
        vec4 color0 = texture2D(sampler2d0, texCoord);
        vec4 color1 = texture2D(sampler2d1, texCoord);
        vec4 color2 = texture2D(sampler2d2, texCoord);
 		if(color0.w>=0.5)
			gl_FragColor = vec4(color0.r, color0.g, color0.b, 1);
		else 
 		if(color1.w>=0.5)
			gl_FragColor = vec4(color1.r, color1.g, color1.b, 1);
		else
		if(color2.w>=0.5)
			gl_FragColor = vec4(color2.r, color2.g, color2.b, 1);
 		else
			gl_FragColor = vec4(0,0,0,0);		
	}
</script>

<script>
    var g = {};

    function init()
    {
        // Initialize
        var gl = initWebGL(
            // The id of the Canvas Element
            "example");
        if (!gl) {
          return;
        }
        var program = simpleSetup(
            gl,
            // The ids of the vertex and fragment shaders
            "vshader", "fshaderCDF",
            // The vertex attribute names used by the shaders.
            // The order they appear here corresponds to their index
            // used later.
            //[ "vNormal", "vColor", "vPosition"],
            [ "vNormal", "vColor", "vPosition"],
            // The clear color and depth values
            [ 0, 0, 0.5, 1 ], 10000);

        // Set some uniform variables for the shaders
        gl.uniform1i(gl.getUniformLocation(program, "sampler2d0"), 0);
        gl.uniform1i(gl.getUniformLocation(program, "sampler2d1"), 1);
        gl.uniform1i(gl.getUniformLocation(program, "sampler2d2"), 2);

        // Create a box. On return 'gl' contains a 'box' property with
        // the BufferObjects containing the arrays for vertices,
        // normals, texture coords, and indices.
        g.box = makeBox(gl);

        // Load an image to use. Returns a WebGLTexture object
		cdfTexture0 = loadImageTexture(gl, "patrick_star-0.png");
		cdfTexture1 = loadImageTexture(gl, "patrick_star-1.png");
		cdfTexture2 = loadImageTexture(gl, "patrick_star-2.png");

        // Create some matrices to use later and save their locations in the shaders
        g.mvMatrix = new J3DIMatrix4();
        //g.u_normalMatrixLoc = gl.getUniformLocation(program, "u_normalMatrix");
        //g.normalMatrix = new J3DIMatrix4();
        g.u_modelViewProjMatrixLoc =
                gl.getUniformLocation(program, "u_modelViewProjMatrix");
        g.mvpMatrix = new J3DIMatrix4();

        // Enable all of the vertex attribute arrays.
        //gl.enableVertexAttribArray(0);
        gl.enableVertexAttribArray(1);
        gl.enableVertexAttribArray(2);

        // Set up all the vertex attributes for vertices, normals and texCoords
        gl.bindBuffer(gl.ARRAY_BUFFER, g.box.vertexObject);
        gl.vertexAttribPointer(2, 3, gl.FLOAT, false, 0, 0);

        //gl.bindBuffer(gl.ARRAY_BUFFER, g.box.normalObject);
        //gl.vertexAttribPointer(0, 3, gl.FLOAT, false, 0, 0);

        gl.bindBuffer(gl.ARRAY_BUFFER, g.box.texCoordObject);
        gl.vertexAttribPointer(1, 2, gl.FLOAT, false, 0, 0);

        // Bind the index array
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, g.box.indexObject);

        return gl;
    }

    var requestId;
    width = -1;
    height = -1;

    function reshape(gl)
    {
        // change the size of the canvas's backing store to match the size it is displayed.
        var canvas = document.getElementById('example');
        if (canvas.width == width && canvas.height == height)
            return;

        width = canvas.width;
        height = canvas.height;

        // Set the viewport and projection matrix for the scene
        gl.viewport(0, 0, width, height);
        g.perspectiveMatrix = new J3DIMatrix4();
        g.perspectiveMatrix.perspective(5, width / height, 1, 10000);
        g.perspectiveMatrix.lookat(0, 0, 7, 0, 0, 0, 0, 1, 0);
    }

    function drawPicture(gl)
    {
        // Make sure the canvas is sized correctly.
        reshape(gl);

        // Clear the canvas
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        // Make a model/view matrix.
        g.mvMatrix.makeIdentity();
        g.mvMatrix.rotate(20, 1,0,0);
        g.mvMatrix.rotate(currentAngle, 0,1,0);

        // Construct the normal matrix from the model-view matrix and pass it in
        //g.normalMatrix.load(g.mvMatrix);
        //g.normalMatrix.invert();
        //g.normalMatrix.transpose();
        //g.normalMatrix.setUniform(gl, g.u_normalMatrixLoc, false);

        // Construct the model-view * projection matrix and pass it in
        g.mvpMatrix.load(g.perspectiveMatrix);
		//g.mvpMatrix.load(g.orhtoMatrix);
        g.mvpMatrix.multiply(g.mvMatrix);
        g.mvpMatrix.setUniform(gl, g.u_modelViewProjMatrixLoc, false);

        // Bind the texture to use
        //gl.bindTexture(gl.TEXTURE_2D, spiritTexture);
				gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, cdfTexture0, 0);
		gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, cdfTexture1, 1);
		gl.activeTexture(gl.TEXTURE2);
        gl.bindTexture(gl.TEXTURE_2D, cdfTexture2, 2);


        // Draw the cube
        gl.drawElements(gl.TRIANGLES, g.box.numIndices, gl.UNSIGNED_BYTE, 0);

        // Show the framerate
        framerate.snapshot();

        currentAngle += incAngle;
        if (currentAngle > 360)
            currentAngle -= 360;
    }

    function start()
    {
        var c = document.getElementById("example");

        //c = WebGLDebugUtils.makeLostContextSimulatingCanvas(c);
        // tell the simulator when to lose context.
        //c.loseContextInNCalls(1);

        c.addEventListener('webglcontextlost', handleContextLost, false);
        c.addEventListener('webglcontextrestored', handleContextRestored, false);

        var gl = init();
        if (!gl) {
           return;
        }

        currentAngle = 0;
        incAngle = 0.5;
        framerate = new Framerate("framerate");
        var f = function() {
            drawPicture(gl);
            requestId = window.requestAnimFrame(f, c);
        };
        f();

        function handleContextLost(e) {
            e.preventDefault();
            clearLoadingImages();
            if (requestId !== undefined) {
                window.cancelAnimFrame(requestId);
                requestId = undefined;
            }
        }

        function handleContextRestored() {
            init();
            f();
        }
    }
</script>
<style type="text/css">
    canvas {
        border: 2px solid black;
    }
</style>
</head>

<body onload="start()">
<canvas height="657" width="1368" id="example">
    If you're seeing this your web browser doesn't support the &lt;canvas&gt;&gt; element. Ouch!
</canvas>
<div id="framerate">Framerate:56fps</div>



</body></html>